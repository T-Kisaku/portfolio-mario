const ot=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerpolicy&&(o.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?o.credentials="include":r.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=e(r);fetch(r.href,o)}};ot();class at{constructor(t,e,i){this.pos=t,this.size=e,this.offset=i}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}}class ct{constructor(){this.events=[]}emit(t,...e){this.events.push({name:t,args:e})}process(t,e){for(const i of this.events)i.name===t&&e(...i.args)}clear(){this.events.length=0}}class v{constructor(t=0,e=0){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}copy(t){this.set(t.x,t.y)}}class ht{constructor(){this.grid=[]}set(t,e,i){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=i}get(t,e){const i=this.grid[t];if(i)return i[e]}delete(t,e){const i=this.grid[t];i&&delete i[e]}*itemsInRange(t,e,i,r){for(let o=t;o<=i;o++)for(let n=e;n<=r;n++){const a=this.get(o,n);a&&(yield[a,o,n])}}forEach(t){for(const[e,i]of this.grid.entries())for(const[r,o]of i.entries())t(o,e,r)}}const U=class{constructor(){this.listeners=[]}listen(s,t,e=1/0){this.listeners.push({name:s,callback:t,count:e})}queue(s){this.listen(U.EVENT_TASK,s,1)}finalize(s){for(const t of this.listeners)s.events.process(t.name,t.callback),t.count-=1;this.listeners=this.listeners.filter(t=>t.count>0)}update(s,t,e){}obstruct(s,t,e){}collides(s,t){}};let d=U;d.EVENT_TASK=Symbol("task");var f=(s=>(s[s.top=0]="top",s[s.bottom=1]="bottom",s[s.left=2]="left",s[s.right=3]="right",s))(f||{});class T{constructor(){this.pos=new v,this.vel=new v,this.size=new v,this.offset=new v,this.bounds=new at(this.pos,this.size,this.offset),this.traits=new Map,this.lifetime=0,this.sounds=new Set,this.events=new ct}addTrait(t){return this.traits.set(t.constructor,t),t}getTrait(t){const e=this.traits.get(t);if(e instanceof t)return e}useTrait(t,e){const i=this.getTrait(t);i&&e(i)}update(t,e){this.traits.forEach(i=>{i.update(this,t,e)}),this.audio&&this.playSounds(this.audio,t.audioContext),this.lifetime+=t.deltaTime}draw(t){}finalize(){this.events.emit(d.EVENT_TASK,this),this.traits.forEach(t=>{t.finalize(this)}),this.events.clear()}obstruct(t,e){this.traits.forEach(i=>{i.obstruct(this,t,e)})}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}playSounds(t,e){this.sounds.forEach(i=>t.play(i,e)),this.sounds.clear()}}function lt(s,t){return function(i){const r=Math.floor(i/t%s.length);return s[r]}}function J(s){return new Promise((t,e)=>{const i=new Image;i.addEventListener("load",()=>{t(i)}),i.addEventListener("error",()=>{e(`Could not load image from ${s}`)}),i.src=s})}function M(s){return fetch(s).then(t=>t.json())}const E=s=>`/portfolio-mario/${s}`;function S(s){throw new Error(s)}class Z{constructor(t,e,i){this.image=t,this.tileWidth=e,this.tileHeight=i,this.tiles=new Map,this.animations=new Map}define(t,e,i,r,o,n,a){const c=[!1,!0].map(h=>{const l=document.createElement("canvas"),u=n&&n||r,m=a&&a||o;l.width=u,l.height=m;const w=l.getContext("2d")||S("Canvas not supported");return h&&(w.scale(-1,1),w.translate(-u,0)),w.drawImage(this.image,e,i,r,o,0,0,u,m),l});this.tiles.set(t,c)}defineTile(t,e,i){this.define(t,e*this.tileWidth,i*this.tileHeight,this.tileWidth,this.tileHeight)}defineAnimation(t,e){this.animations.set(t,e)}draw(t,e,i,r,o=!1){const n=this.tiles.get(t);if(!n)throw new Error(`SpriteSheet.draw(): Sprite "${t}" not found`);e.drawImage(n[o?1:0],i,r)}drawTile(t,e,i,r){this.draw(t,e,i*this.tileWidth,r*this.tileHeight)}drawAnimation(t,e,i,r,o){const n=this.animations.get(t);if(!n)throw new Error(`Animation not found: ${t}`);this.drawTile(n(o),e,i,r)}getAnimation(t){const e=this.animations.get(t);if(!e)throw new Error(`Animation not found: ${t}`);return e}}async function L(s,t,e){const i=`sprites/${s}.json`,r=await M(E(i)),o=await J(r.imageURL),n=new Z(o,r.tileW,r.tileH);return r.tiles&&r.tiles.forEach(a=>{const[c,h]=a.index;n.defineTile(a.name,c,h)}),r.frames&&r.frames.forEach(a=>{const[c,h,l,u]=a.rect;n.define(a.name,c,h,l,u,t,e)}),r.animations&&r.animations.forEach(a=>{const c=lt(a.frames,a.frameLength);n.defineAnimation(a.name,c)}),n}class dt extends d{update(t,{deltaTime:e},i){t.vel.y+=i.gravity*e}}class p extends d{constructor(){super(...arguments),this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>{this.dead=!0})}revive(){this.dead=!1,this.deadTime=0}update(t,{deltaTime:e},i){this.dead&&(this.deadTime+=e,this.deadTime>this.removeAfter&&this.queue(()=>{i.entities.delete(t)}))}}const Q=class extends d{constructor(){super(...arguments),this.bounceSpeed=400}bounce(s,t){s.bounds.bottom=t.bounds.top,s.vel.y=-this.bounceSpeed}collides(s,t){const e=t.getTrait(p);!e||e.dead||s.vel.y>t.vel.y&&(this.queue(()=>this.bounce(s,t)),s.sounds.add("stomp"),s.events.emit(Q.EVENT_STOMP,s,t))}};let b=Q;b.EVENT_STOMP=Symbol("stomp");class ut extends d{update(t,{deltaTime:e}){t.pos.x+=t.vel.x*e,t.pos.y+=t.vel.y*e}}class ft extends d{constructor(){super(...arguments),this.gravity=new dt}collides(t,e){var r,o,n;if((r=t.getTrait(p))!=null&&r.dead)return;e.getTrait(b)&&(e.vel.y>t.vel.y?((o=t.getTrait(p))==null||o.kill(),t.vel.set(100,-200)):(n=e.getTrait(p))==null||n.kill())}update(t,e,i){var r;(r=t.getTrait(p))!=null&&r.dead&&this.gravity.update(t,e,i)}}async function pt(){const s=await L("bullet");return function(){const e=new T;return e.size.set(16,14),e.vel.set(80,0),e.addTrait(new ft),e.addTrait(new p),e.addTrait(new ut),e.draw=i=>{s.draw("bullet",i,0,0,e.vel.x<0)},e}}class mt{constructor(){this.buffers=new Map}add(t,e){this.buffers.set(t,e)}play(t,e){const i=e.createBufferSource();i.connect(e.destination),i.buffer=this.buffers.get(t),i.start(0)}}function gt(s){return async function(e){const r=await(await fetch(e)).arrayBuffer();return s.decodeAudioData(r)}}async function K(s,t){const e=gt(t),i=await M(E(`sounds/${s}.json`)),r=new mt,o=Object.entries(i.fx).map(([n,{url:a}])=>e(E(a)).then(c=>r.add(n,c)).catch(()=>console.error(`failed to load ${a}`)));return await Promise.all(o),r}const H=100;class y extends d{constructor(){super(),this.name="UNNAMED",this.coins=0,this.lives=3,this.score=0,this.listen(b.EVENT_STOMP,()=>{this.score+=100})}addCoins(t){for(this.coins+=t;this.coins>=H;)this.addLives(1),this.coins-=H;this.queue(e=>e.sounds.add("coin"))}addLives(t){this.lives+=t}}class wt extends d{constructor(t){super(),this.player=t,this.checkpoint=new v(0,0)}update(t,e,i){var r;i.entities.has(this.player)||((r=this.player.getTrait(p))==null||r.revive(),this.player.pos.set(this.checkpoint.x,this.checkpoint.y),i.entities.add(this.player))}}function Tt(s){const t=new T,e=new wt(s);return e.checkpoint.set(64,64),t.addTrait(e),t}function*D(s){for(const t of s)t.getTrait(y)&&(yield t)}function yt(s,t){const e=new y;e.name=t,s.addTrait(e)}class vt extends d{constructor(){super(...arguments),this.interval=2,this.coolDown=this.interval,this.emitters=[]}update(t,e,i){this.coolDown-=e.deltaTime,this.coolDown<=0&&(this.emit(t,e,i),this.coolDown=this.interval)}emit(t,e,i){for(const r of this.emitters)r(t,e,i)}}const bt=30;async function xt(s){const t=await K("cannon",s),e=(r,o)=>Math.abs(r.pos.x-o.pos.x);function i(r,o,n){var m,w;const a=(w=(m=o.entityFactory).bullet)==null?void 0:w.call(m);if(!a)return;const c=[...D(n.entities)];if(c.some(g=>e(g,r)<=bt))return;const u=c.reduce((g,P)=>{const z=e(g,r);return e(P,r)<z?P:g}).pos.x<r.pos.x?-1:1;a.pos.copy(r.pos),a.vel.x=80*u,n.entities.add(a),r.sounds.add("shoot")}return function(){const o=new T;o.audio=t;const n=new vt;return n.interval=4,n.emitters.push(i),o.addTrait(n),o}}class x extends d{constructor(){super(...arguments),this.speed=-30,this.enabled=!0}update(t){this.enabled&&(t.vel.x=this.speed)}obstruct(t,e){e===f.left?this.speed=Math.abs(this.speed):e===f.right&&(this.speed=-Math.abs(this.speed))}}class O extends d{update(t,e,i){t.pos.x+=t.vel.x*e.deltaTime,i.tileCollider.checkX(t,e,i),t.pos.y+=t.vel.y*e.deltaTime,i.tileCollider.checkY(t,e,i),t.vel.y+=i.gravity*e.deltaTime}}class I extends d{constructor(){super(...arguments),this.obstructs=!0}obstruct(t,e,i){!this.obstructs||(e===f.bottom?(t.bounds.bottom=i.y1,t.vel.y=0):e===f.top?(t.bounds.top=i.y2,t.vel.y=0):e===f.right?(t.bounds.right=i.x1,t.vel.x=0):e===f.left&&(t.bounds.left=i.x2,t.vel.x=0))}}class Et extends d{collides(t,e){var r,o;if((r=t.getTrait(p))!=null&&r.dead)return;e.getTrait(b)&&(e.vel.y>t.vel.y?(t.useTrait(x,n=>n.speed=0),t.useTrait(p,n=>n.kill())):(o=e.getTrait(p))==null||o.kill())}}class St extends T{constructor(t,e){super(),this.sprites=t,this.walkAnim=e,this.walk=this.addTrait(new x),this.behavior=this.addTrait(new Et),this.killable=this.addTrait(new p),this.solid=this.addTrait(new I),this.physics=this.addTrait(new O),this.size.set(16,16)}draw(t){this.sprites.draw(this.routeAnim(),t,0,0)}routeAnim(){return this.killable.dead?"flat":this.walkAnim(this.lifetime)}}async function kt(){const s=await L("goomba"),t=s.getAnimation("walk");return function(){return new St(s,t)}}class At extends d{constructor(){super(...arguments),this.state=0,this.hideTime=0,this.hideDuration=5,this.panicSpeed=300}collides(t,e){var r;if((r=t.getTrait(p))!=null&&r.dead)return;e.getTrait(b)&&(e.vel.y>t.vel.y?this.handleStomp(t,e):this.handleNudge(t,e))}handleStomp(t,e){this.state===0?this.hide(t):this.state===1?(t.useTrait(p,i=>i.kill()),t.vel.set(100,-200),t.useTrait(I,i=>i.obstructs=!1)):this.state===2&&this.hide(t)}handleNudge(t,e){const i=()=>{const r=e.getTrait(p);r&&r.kill()};if(this.state===0)i();else if(this.state===1)this.panic(t,e);else if(this.state===2){const r=Math.sign(t.vel.x),o=Math.sign(t.pos.x-e.pos.x);r!==0&&r!==o&&i()}}hide(t){t.useTrait(x,e=>{t.vel.x=0,e.enabled=!1,this.walkSpeed||(this.walkSpeed=e.speed),this.state=1,this.hideTime=0})}unhide(t){t.useTrait(x,e=>{e.enabled=!0,this.walkSpeed!=null&&(e.speed=this.walkSpeed),this.state=0})}panic(t,e){t.useTrait(x,i=>{i.speed=this.panicSpeed*Math.sign(e.vel.x),i.enabled=!0}),this.state=2}update(t,{deltaTime:e}){this.state===1&&(this.hideTime+=e,this.hideTime>this.hideDuration&&this.unhide(t))}}class Lt extends T{constructor(t){super(),this.sprites=t,this.walk=this.addTrait(new x),this.behavior=this.addTrait(new At),this.killable=this.addTrait(new p),this.solid=this.addTrait(new I),this.physics=this.addTrait(new O),this.walkAnim=this.sprites.getAnimation("walk"),this.wakeAnim=this.sprites.getAnimation("wake"),this.size.set(16,16),this.offset.set(0,8)}draw(t){this.sprites.draw(this.routeAnim(),t,0,0,this.vel.x<0)}routeAnim(){return this.behavior.state===1?this.behavior.hideTime>3?this.wakeAnim(this.behavior.hideTime):"hiding":this.behavior.state===2?"hiding":this.walkAnim(this.lifetime)}}async function Rt(){const s=await L("koopa");return function(){return new Lt(s)}}class R extends d{constructor(){super(...arguments),this.duration=.3,this.velocity=200,this.engageTime=0,this.ready=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}update(t,{deltaTime:e}){this.requestTime>0&&(this.ready>0&&(t.sounds.add("jump"),this.engageTime=this.duration,this.requestTime=0),this.requestTime-=e),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),this.engageTime-=e),this.ready-=1}obstruct(t,e){e===f.bottom?this.ready=1:e===f.top&&this.cancel()}get falling(){return this.ready<0}}class B extends d{constructor(){super(...arguments),this.dir=0,this.acceleration=400,this.distance=0,this.heading=1,this.dragFactor=1/5e3,this.deceleration=300}update(t,{deltaTime:e}){const i=Math.abs(t.vel.x);if(this.dir!==0){t.vel.x+=this.acceleration*this.dir*e;const o=t.getTrait(R);o?o.falling===!1&&(this.heading=this.dir):this.heading=this.dir}else if(t.vel.x!==0){const o=Math.min(i,this.deceleration*e);t.vel.x+=-Math.sign(t.vel.x)*o}else this.distance=0;const r=this.dragFactor*t.vel.x*i;t.vel.x-=r,this.distance+=i*e}}const Mt=1/5e3,j=1/1e3;class tt extends T{constructor(t,e,i){super(),this.sprites=t,this.audio=e,this.runAnimation=i,this.jump=this.addTrait(new R),this.go=this.addTrait(new B),this.stomper=this.addTrait(new b),this.killable=this.addTrait(new p),this.solid=this.addTrait(new I),this.physics=this.addTrait(new O),this.size.set(14,16),this.go.dragFactor=j,this.killable.removeAfter=0,this.setTurboState(!1)}resolveAnimationFrame(){return this.jump.falling?"jump":this.go.distance>0?this.vel.x>0&&this.go.dir<0||this.vel.x<0&&this.go.dir>0?"brake":this.runAnimation(this.go.distance):"idle"}draw(t){this.sprites.draw(this.resolveAnimationFrame(),t,0,0,this.go.heading<0)}setTurboState(t){this.go.dragFactor=t?Mt:j}}async function It(s){const[t,e]=await Promise.all([L("mario"),K("mario",s)]),i=t.getAnimation("run");return function(){return new tt(t,e,i)}}const Pt=1/5e3,q=1/1e3,N={width:16*4,height:16*4};class et extends T{constructor(t,e,i){super(),this.sprites=t,this.audio=e,this.animations=i,this.jump=this.addTrait(new R),this.go=this.addTrait(new B),this.stomper=this.addTrait(new b),this.killable=this.addTrait(new p),this.solid=this.addTrait(new I),this.physics=this.addTrait(new O),this.size.set(N.width,N.width),this.go.dragFactor=q,this.killable.removeAfter=0,this.setTurboState(!1)}resolveAnimationFrame(){return this.jump.falling?this.animations.jump(this.go.distance):this.go.distance>0?this.vel.x>0&&this.go.dir<0||this.vel.x<0&&this.go.dir>0?"brake":this.animations.run(this.go.distance):"idle"}draw(t){this.sprites.draw(this.resolveAnimationFrame(),t,0,0,this.go.heading<0)}setTurboState(t){this.go.dragFactor=t?Pt:q}}async function zt(s){const[t,e]=await Promise.all([L("takashi",N.width,N.height),K("takashi",s)]);return function(){return new et(t,e,{run:t.getAnimation("run"),jump:t.getAnimation("jump")})}}async function Ct(s){const t={},e=i=>r=>{t[i]=r};return await Promise.all([It(s).then(e("mario")),zt(s).then(e("takashi")),kt().then(e("goomba")),Rt().then(e("koopa")),pt().then(e("bullet")),xt(s).then(e("cannon"))]),t}class _t{constructor(){this.receivers=new Set}addReceiver(t){this.receivers.add(t)}dropReceiver(t){this.receivers.delete(t)}route(t){for(const e of this.receivers)t(e)}}class Bt{constructor(){this.keyStates=new Map,this.keyListeners=new Map}addListener(t,e){this.keyListeners.set(t,e),this.keyStates.set(t,0)}listenTo(t){["keydown","keyup"].forEach(i=>{t.addEventListener(i,r=>{this.handleEvent(r)})})}handleEvent(t){if(t.repeat)return;const e=this.keyListeners.get(t.code),i=t.type==="keydown"?1:0;e&&(this.keyStates.set(t.code,i),e(i),t.preventDefault())}}function Nt(s){const t=new Bt,e=new _t,i=(n,a)=>n.forEach(c=>t.addListener(c,a));let r=0,o=0;return t.listenTo(s),i(["ArrowRight","KeyD"],n=>{o=n,e.route(a=>{a.useTrait(B,c=>{c.dir=o-r})})}),i(["ArrowLeft","KeyA"],n=>{r=n,e.route(a=>{a.useTrait(B,c=>{c.dir=o-r})})}),i(["KeyZ","Space","ArrowUp"],n=>{n?e.route(a=>{a.useTrait(R,c=>c.start())}):e.route(a=>{a.useTrait(R,c=>c.cancel())})}),i(["KeyX","KeyF"],n=>{e.route(a=>{(a instanceof et||a instanceof tt)&&a.setTurboState(n===1)})}),e}function W(s){return function(e){e.fillStyle=s,e.fillRect(0,0,e.canvas.width,e.canvas.height)}}const G=class extends d{constructor(){super(...arguments),this.totalTime=300,this.currentTime=this.totalTime,this.hurryTime=100}update(s,{deltaTime:t},e){this.currentTime-=t*2,this.hurryEmitted!==!0&&this.currentTime<this.hurryTime&&(e.events.emit(G.EVENT_TIMER_HURRY),this.hurryEmitted=!0),this.hurryEmitted!==!1&&this.currentTime>this.hurryTime&&(e.events.emit(G.EVENT_TIMER_OK),this.hurryEmitted=!1)}};let k=G;k.EVENT_TIMER_HURRY=Symbol("timer hurry");k.EVENT_TIMER_OK=Symbol("timer ok");function Dt(s){for(const t of D(s.entities)){const e=t.getTrait(y);if(e)return e}}function Ot(s){for(const t of s.entities){const e=t.getTrait(k);if(e)return e}}function Ft(s,t){const e=s.size,i=s.size*2;return function(o){const n=Dt(t);n&&(s.print(n.name,o,16,e),s.print(String(n.score).padStart(6,"0"),o,16,i),s.print("@x"+String(n.coins).padStart(2,"0"),o,96,i)),s.print("WORLD",o,152,e),s.print(t.name,o,160,i);const a=Ot(t);a&&(s.print("TIME",o,208,e),s.print(String(Math.floor(a.currentTime)).padStart(3,"0"),o,216,i))}}function $t(s){for(const t of D(s.entities))if(t.getTrait(y))return t;throw new Error("player not found")}function Gt(s,t){const e=s.size,i=document.createElement("canvas");i.width=32,i.height=32;const r=i.getContext("2d")||S("Canvas not supported");return function(n){var h;const a=$t(t);s.print(`WORLD ${t.name}`,n,e*12,e*12),r.clearRect(0,0,i.width,i.height),a.draw(r),n.drawImage(i,e*12,e*15);const c=String((h=a.getTrait(y))==null?void 0:h.lives).padStart(2," ");s.print(`x ${c}`,n,e*16,e*16)}}function Kt(s,t){return function(i){const r=Math.floor(i.canvas.width/s.size),o=Math.floor(i.canvas.height/s.size),n=r/2-t.length/2,a=o/2;s.print(t,i,n*s.size,a*s.size)}}class st{constructor(){this.pos=new v(0,0),this.size=new v(256,224)}}class Vt{constructor(t){this.entities=t}check(t){for(const e of this.entities)t!==e&&t.bounds.overlaps(e.bounds)&&t.collides(e)}}class Ht{setPlayer(t){this.player=t}playTheme(t=1){var i;const e=(i=this.player)==null?void 0:i.playTrack("main");e&&(e.playbackRate=t)}playHurryTheme(){var e;const t=(e=this.player)==null?void 0:e.playTrack("hurry");t&&(t.loop=!1,t.addEventListener("ended",()=>this.playTheme(1.3),{once:!0}))}pause(){var t;(t=this.player)==null||t.pauseAll()}}class jt{constructor(){this.layers=[]}draw(t,e){this.layers.forEach(i=>{i(t,e)})}}class qt{constructor(){this.listeners=[]}listen(t,e){this.listeners.push({name:t,callback:e})}emit(t,...e){this.listeners.filter(i=>i.name===t).forEach(i=>i.callback(...e))}}class A{constructor(){this.comp=new jt,this.events=new qt}draw(t){this.comp.draw(t.videoContext,new st)}update(t){}pause(){}}A.EVENT_COMPLETE=Symbol("scene complete");class it{constructor(t,e=16){this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}*toIndexRange(t,e){const i=Math.ceil(e/this.tileSize)*this.tileSize;for(let r=t;r<i;r+=this.tileSize)yield this.toIndex(r)}getByIndex(t,e){const i=this.matrix.get(t,e);if(i){const r=t*this.tileSize,o=(t+1)*this.tileSize,n=e*this.tileSize,a=(e+1)*this.tileSize;return{tile:i,x1:r,x2:o,y1:n,y2:a,indexX:t,indexY:e}}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}*searchByRange(t,e,i,r){for(const o of this.toIndexRange(t,e))for(const n of this.toIndexRange(i,r)){const a=this.getByIndex(o,n);a&&(yield a)}}}const Wt=({entity:s,match:t})=>{s.vel.x>0?s.bounds.right>t.x1&&s.obstruct(f.right,t):s.vel.x<0&&s.bounds.left<t.x2&&s.obstruct(f.left,t)},Xt=({entity:s,match:t,resolver:e,gameContext:i,level:r})=>{if(s.vel.y>0)s.bounds.bottom>t.y1&&s.obstruct(f.bottom,t);else if(s.vel.y<0){if(s.getTrait(y)){e.matrix.delete(t.indexX,t.indexY);const n=i.entityFactory.goomba();n.vel.set(50,-400),n.pos.set(s.pos.x,t.y1),r.entities.add(n)}s.bounds.top<t.y2&&s.obstruct(f.top,t)}},Yt=[Wt,Xt],X=({entity:s,match:t,resolver:e})=>{const i=s.getTrait(y);i&&(e.matrix.delete(t.indexX,t.indexY),i.addCoins(1))},Ut=[X,X],Jt=({entity:s,match:t})=>{s.vel.x>0?s.bounds.right>t.x1&&s.obstruct(f.right,t):s.vel.x<0&&s.bounds.left<t.x2&&s.obstruct(f.left,t)},Zt=({entity:s,match:t})=>{s.vel.y>0?s.bounds.bottom>t.y1&&s.obstruct(f.bottom,t):s.vel.y<0&&s.bounds.top<t.y2&&s.obstruct(f.top,t)},Qt=[Jt,Zt],te={ground:Qt,brick:Yt,coin:Ut};class ee{constructor(){this.resolvers=[]}addGrid(t){this.resolvers.push(new it(t))}checkX(t,e,i){let r;if(t.vel.x>0)r=t.bounds.right;else if(t.vel.x<0)r=t.bounds.left;else return;for(const o of this.resolvers){const n=o.searchByRange(r,r,t.bounds.top,t.bounds.bottom);for(const a of n)this.handle(0,t,a,o,e,i)}}checkY(t,e,i){let r;if(t.vel.y>0)r=t.bounds.bottom;else if(t.vel.y<0)r=t.bounds.top;else return;for(const o of this.resolvers){const n=o.searchByRange(t.bounds.left,t.bounds.right,r,r);for(const a of n)this.handle(1,t,a,o,e,i)}}handle(t,e,i,r,o,n){var c,h;const a={entity:e,match:i,resolver:r,gameContext:o,level:n};(h=(c=te[i.tile.type])==null?void 0:c[t])==null||h.call(c,a)}}class F extends A{constructor(){super(...arguments),this.name="",this.entities=new Set,this.entityCollider=new Vt(this.entities),this.tileCollider=new ee,this.music=new Ht,this.camera=new st,this.gravity=1500,this.totalTime=0}update(t){this.entities.forEach(e=>{e.update(t,this)}),this.entities.forEach(e=>{this.entityCollider.check(e)}),this.entities.forEach(e=>{e.finalize()}),this.totalTime+=t.deltaTime,se(this)}draw(t){this.comp.draw(t.videoContext,this.camera)}pause(){this.music.pause()}}F.EVENT_TRIGGER=Symbol("trigger");function se(s){for(const t of D(s.entities))s.camera.pos.x=Math.max(0,t.pos.x-100)}const ie=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";class re{constructor(t,e){this.sprites=t,this.size=e}print(t,e,i,r){for(const[o,n]of[...t].entries())this.sprites.draw(n,e,i+o*this.size,r)}}async function ne(){const s=await J("images/font.png"),t=new Z(s,8,8),e=8,i=s.width;for(const[r,o]of[...ie].entries()){const n=r*e%i,a=Math.floor(r*e/i)*e;t.define(o,n,a,e,e)}return new re(t,8)}function oe(s,t,e){const i=new it(t),r=document.createElement("canvas");r.width=256+16,r.height=240;const o=r.getContext("2d")||S("Canvas not supported");function n(a,c){o.clearRect(0,0,r.width,r.height);const h=t.itemsInRange(a,0,c,r.height/16);for(const[l,u,m]of h)!l.name||(e.animations.has(l.name)?e.drawAnimation(l.name,o,u-a,m,s.totalTime):e.drawTile(l.name,o,u-a,m))}return function(c,h){const l=i.toIndex(h.size.x),u=i.toIndex(h.pos.x),m=u+l;n(u,m),c.drawImage(r,-h.pos.x%16,-h.pos.y)}}function ae(s,t=64,e=64){const i=document.createElement("canvas");i.width=t,i.height=e;const r=i.getContext("2d")||S("Canvas not supported");return function(n,a){s.forEach(c=>{r.clearRect(0,0,t,e),c.draw(r),n.drawImage(i,c.pos.x-a.pos.x,c.pos.y-a.pos.y)})}}class ce extends d{constructor(){super(...arguments),this.touches=new Set,this.conditions=[]}collides(t,e){this.touches.add(e)}update(t,e,i){if(this.touches.size>0){for(const r of this.conditions)r(t,this.touches,e,i);this.touches.clear()}}}class he{constructor(){this.tracks=new Map}addTrack(t,e){const i=new Audio;i.loop=!0,i.src=e,this.tracks.set(t,i)}playTrack(t){this.pauseAll();const e=this.tracks.get(t);return e==null||e.play(),e}pauseAll(){for(const t of this.tracks.values())t.pause()}}async function le(s){const t=await M(E(`music/${s}.json`)),e=new he;for(const[i,r]of Object.entries(t))e.addTrack(i,r.url);return e}function de(){const s=new T;return s.addTrait(new k),s}function ue(s){return M(E(`sprites/patterns/${s}.json`))}function fe(s){const t=de();s.entities.add(t),s.events.listen(k.EVENT_TIMER_OK,()=>{s.music.playTheme()}),s.events.listen(k.EVENT_TIMER_HURRY,()=>{s.music.playHurryTheme()})}function pe(s,t,e,i){for(const r of s.layers){const o=Te(r.tiles,i),n=oe(t,o,e);t.comp.layers.push(n),t.tileCollider.addGrid(o)}}function me(s,t,e){s.entities.forEach(({name:r,pos:[o,n]})=>{const a=e[r];if(!a)throw new Error(`Could not find factory function for entity "${r}"`);const c=a();c.pos.set(o,n),t.entities.add(c)});const i=ae(t.entities);t.comp.layers.push(i)}function ge(s,t){if(!!s.triggers)for(const e of s.triggers){const i=new ce;i.conditions.push((o,n,a,c)=>{c.events.emit(F.EVENT_TRIGGER,e,o,n)});const r=new T;r.addTrait(i),r.pos.set(...e.pos),r.size.set(64,64),t.entities.add(r)}}function we(s){return async function(e){const i=await M(E(`levels/${e}.json`)),[r,o,n]=await Promise.all([L(i.spriteSheet),le(i.musicSheet),ue(i.patternSheet)]),a=new F;return a.name=e,a.music.setPlayer(o),pe(i,a,r,n),me(i,a,s),ge(i,a),fe(a),a}}function Te(s,t){const e=new ht;for(const{x:i,y:r,tile:o}of be(s,t))e.set(i,r,o);return e}function*$(s,t,e,i){const r=s+t,o=e+i;for(let n=s;n<r;n++)for(let a=e;a<o;a++)yield{x:n,y:a}}function ye(s){if(s.length===4){const[t,e,i,r]=s;return $(t,e,i,r)}else if(s.length===3){const[t,e,i]=s;return $(t,e,i,1)}else if(s.length===2){const[t,e]=s;return $(t,1,e,1)}else throw new Error(`Invalid range of length ${s.length}`)}function*ve(s){for(const t of s)yield*ye(t)}function*be(s,t){function*e(i,r,o){for(const n of i)for(const{x:a,y:c}of ve(n.ranges)){const h=a+r,l=c+o;if(n.pattern){if(!t[n.pattern])throw new Error(`pattern ${n.pattern} not found`);const{tiles:u}=t[n.pattern];yield*e(u,h,l)}else if(n.name)yield{tile:n,x:h,y:l};else throw new Error(`Tile does not have a name or a pattern: ${JSON.stringify(n)}`)}}yield*e(s,0,0)}class xe{constructor(){this.sceneIndex=-1,this.scenes=[]}get currentScene(){return this.scenes[this.sceneIndex]}addScene(t){this.scenes.push(t),t.events.listen(A.EVENT_COMPLETE,()=>{this.runNext()})}runNext(){var t;(t=this.currentScene)==null||t.pause(),this.sceneIndex+=1}update(t){var e,i;(e=this.currentScene)==null||e.update(t),(i=this.currentScene)==null||i.draw(t)}}class Ee extends A{constructor(){super(...arguments),this.countDown=2}update(t){this.countDown-=t.deltaTime,this.countDown<=0&&this.events.emit(A.EVENT_COMPLETE)}}class Se{constructor(t=1/60){this.deltaTime=t,this.accumulatedTime=0,this.update=e=>{},this.updateProxy=e=>{if(this.lastTime!=null)for(this.accumulatedTime+=(e-this.lastTime)/1e3,this.accumulatedTime=Math.min(this.accumulatedTime,1);this.accumulatedTime>this.deltaTime;)this.update(this.deltaTime),this.accumulatedTime-=this.deltaTime;this.lastTime=e,this.enqueue()}}start(){this.enqueue()}enqueue(){requestAnimationFrame(this.updateProxy)}}async function ke(s){var u;const t=s.getContext("2d")||S("Canvas not supported");t.imageSmoothingEnabled=!1;const e=new AudioContext,[i,r]=await Promise.all([Ct(e),ne()]),o=we(i),n=new xe,a=((u=i.takashi)==null?void 0:u.call(i))||S("where takashi tho");yt(a,"TAKASHI"),Nt(window).addReceiver(a);async function h(m){const w=new A;w.comp.layers.push(W("black")),w.comp.layers.push(Kt(r,`LOADING ${m}...`)),n.addScene(w),n.runNext(),await new Promise(_=>setTimeout(_,500));const g=await o(m);g.events.listen(F.EVENT_TRIGGER,(_,Ae,rt)=>{if(_.type==="goto"){for(const nt of rt)if(nt.getTrait(y)){h(_.name);return}}});const P=Gt(r,g),z=Ft(r,g);a.pos.set(0,1),a.vel.set(0,0),g.entities.add(a);const V=Tt(a);g.entities.add(V);const C=new Ee;C.comp.layers.push(W("black")),C.comp.layers.push(z),C.comp.layers.push(P),n.addScene(C),g.comp.layers.push(z),n.addScene(g),n.runNext()}const l=new Se;l.update=function(w){if(!document.hasFocus())return;const g={deltaTime:w,audioContext:e,entityFactory:i,videoContext:t};n.update(g)},l.start(),h("debug-progression")}const Y=document.getElementById("screen");Y instanceof HTMLCanvasElement?ke(Y).catch(console.error):console.warn("Canvas not found");
